2章 SQL入門
---

# 2.1 SELEC文の基本構文と実行順序

## SELECT文の基本構文

```sql
SELECT [ 列名 | 式 | * ]      -- 取得する列名や計算式を指定
FROM テーブル名                -- データを取得するテーブルやビューを指定
[WHERE 条件]                  -- 行の絞り込み条件
[GROUP BY 列名]               -- グルーピングするカラムを指定
[HAVING 条件]                 -- グループ単位での絞り込み条件
[ORDER BY 列名 [ASC|DESC]]    -- 結果の並び順
[LIMIT 数]                    -- 取得する行数の制限
[OFFSET 数]                   -- 取得開始位置の指定
```

## SELECT文の実行順序

1. **FROM** 指定したテーブルからデータを取得。JOINもこの段階で処理される。
1. **WHERE** 取得した行を条件で絞り込み
1. **GROUP BY** WHEREで絞り込んだ結果をグループ化
1. **HAVING** グループ化した結果を条件で絞り込み
1. **SELECT** 取得する列や計算式を選択
1. **ORDER BY** 結果瀬戸を指定した列で並び替える
1. **LIMIT / OFFSET** 返却する行数や開始位置を制御

サンプルクエリ

```sql
SELECT category_id, AVG(price) AS avg_price
FROM products
WHERE created_at >= '2026-01-01'
GROUP BY category_id
HAVING AVG(price) > 5000
ORDER BY avg_price ASC
LIMIT 10;
```


## PostgreSQL特有のポイント

### 1. 式や関数の利用

PostgreSQLはは標準のSQLに加えて、豊富な関数をサポートしています。


## 文字列関数

| 関数 | 説明 | 例 | 結果 |
|------|------|-----|------|
| `length(str)` | 文字数を返す | `length('こんにちは')` | `5` |
| `octet_length(str)` | バイト数を返す | `octet_length('こんにちは')` | `15` |
| `upper(str)` | 大文字に変換 | `upper('hello')` | `HELLO` |
| `lower(str)` | 小文字に変換 | `lower('HELLO')` | `hello` |
| `initcap(str)` | 単語の先頭を大文字に | `initcap('hello world')` | `Hello World` |
| `concat(str1, str2, ...)` | 文字列を連結 | `concat('a', 'b', 'c')` | `abc` |
| `concat_ws(sep, str1, ...)` | 区切り文字付きで連結 | `concat_ws('-', '2025', '01', '06')` | `2025-01-06` |
| `substring(str, start, len)` | 部分文字列を取得 | `substring('PostgreSQL', 1, 4)` | `Post` |
| `trim(str)`<br>`ltrim(str)` `rtrim(str)`もある | 前後の空白を除去 | `trim('  hello  ')` | `hello` |
| `replace(str, from, to)` | 文字列を置換 | `replace('abc', 'b', 'x')` | `axc` |
| `reverse(str)` | 文字列を反転 | `reverse('hello')` | `olleh` |
| `lpad(str, len, fill)` | 左を埋める | `lpad('5', 3, '0')` | `005` |
| `rpad(str, len, fill)` | 右を埋める | `rpad('5', 3, '0')` | `500` |
| `strpos(str, sub)` | 部分文字列の位置 | `strpos('PostgreSQL', 'gre')` | `5` |
| `split_part(str, delim, n)` | 分割してn番目を取得 | `split_part('a,b,c', ',', 2)` | `b` |
| `string_to_array(str, delim)` | 配列に分割 | `string_to_array('a,b,c', ',')` | `{a,b,c}` |
| `array_to_string(arr, delim)` | 配列を文字列に | `array_to_string('{a,b,c}', '-')` | `a-b-c` |
| `regexp_replace(str, pattern, replacement)` | 正規表現で置換 | `regexp_replace('abc123', '[0-9]', 'X', 'g')` | `abcXXX` |
| `regexp_matches(str, pattern)` | 正規表現でマッチ | `regexp_matches('abc123', '[0-9]+')` | `{123}` |

---

## 数値関数

| 関数 | 説明 | 例 | 結果 |
|------|------|-----|------|
| `abs(n)` | 絶対値 | `abs(-5)` | `5` |
| `round(n)` | 四捨五入（整数） | `round(4.6)` | `5` |
| `round(n, s)` | 四捨五入（小数点以下s桁） | `round(3.14159, 2)` | `3.14` |
| `trunc(n)` | 切り捨て（整数） | `trunc(4.9)` | `4` |
| `trunc(n, s)` | 切り捨て（小数点以下s桁） | `trunc(3.14159, 2)` | `3.14` |
| `ceil(n)` / `ceiling(n)` | 切り上げ | `ceil(4.1)` | `5` |
| `floor(n)` | 切り下げ | `floor(4.9)` | `4` |
| `mod(a, b)` | 剰余 | `mod(10, 3)` | `1` |
| `power(a, b)` | aのb乗 | `power(2, 3)` | `8` |
| `sqrt(n)` | 平方根 | `sqrt(16)` | `4` |
| `ln(n)` | 自然対数 | `ln(2.718)` | `0.999...` |
| `log(base, n)` | 任意の底の対数 | `log(2, 8)` | `3` |
| `sign(n)` | 符号（-1, 0, 1） | `sign(-5)` | `-1` |
| `random()` | 0〜1のランダム値 | `random()` | `0.37...` |
| `greatest(a, b, ...)` | 最大値 | `greatest(1, 5, 3)` | `5` |
| `least(a, b, ...)` | 最小値 | `least(1, 5, 3)` | `1` |

---

## 日付・時刻関数

| 関数 | 説明 | 例 | 結果 |
|------|------|-----|------|
| `now()` | 現在日時（トランザクション開始時） | `now()` | `2025-01-06 10:30:00+09` |
| `current_timestamp` | 現在日時（now()と同じ） | `current_timestamp` | `2025-01-06 10:30:00+09` |
| `current_date` | 現在日付 | `current_date` | `2025-01-06` |
| `current_time` | 現在時刻 | `current_time` | `10:30:00+09` |
| `clock_timestamp()` | リアルタイム現在時刻 | `clock_timestamp()` | 呼び出し時点の時刻 |
| `date_trunc(field, source)` | 指定精度で切り捨て | `date_trunc('month', now())` | `2025-01-01 00:00:00` |
| `extract(field from source)`(SQL標準) <br>`date_part(field, source)` | 日時要素を抽出 | `extract(year from now())`<br>`date_part('month', now())`| `2025`<br>`1` |
| `age(timestamp)` | 現在からの経過時間 | `age('2000-01-01')` | `25 years 6 days` (INTERVAL型) |
| `age(ts1, ts2)` | 2つの日時の差 | `age('2025-01-06', '2020-01-01')` | `5 years 5 days` (INTERVAL型) |
| `to_char(datetime, format)` | 日時を文字列に変換 | `to_char(now(), 'YYYY-MM-DD')` | `2025-01-06` |
| `to_date(str, format)` | 文字列を日付に変換 | `to_date('2025-01-06', 'YYYY-MM-DD')` | `2025-01-06` |
| `to_timestamp(str, format)` | 文字列をタイムスタンプに | `to_timestamp('2025-01-06 10:30', 'YYYY-MM-DD HH24:MI')` | `2025-01-06 10:30:00` |
| `make_date(y, m, d)` | 日付を作成 | `make_date(2025, 1, 6)` | `2025-01-06` |
| `make_timestamp(...)` | タイムスタンプを作成 | `make_timestamp(2025, 1, 6, 10, 30, 0)` | `2025-01-06 10:30:00` |

### date_trunc のfield一覧

| field | 説明 |
|-------|------|
| `microseconds` | マイクロ秒 |
| `milliseconds` | ミリ秒 |
| `second` | 秒 |
| `minute` | 分 |
| `hour` | 時 |
| `day` | 日 |
| `week` | 週 |
| `month` | 月 |
| `quarter` | 四半期 |
| `year` | 年 |

### to_charのフォーマット

| パターン | 説明 | 例 |
|----------|------|-----|
| `YYYY` | 4桁の年 | `2025` |
| `MM` | 月（01-12） | `01` |
| `DD` | 日（01-31） | `06` |
| `HH24` | 時（00-23） | `14` |
| `HH12` | 時（01-12） | `02` |
| `MI` | 分（00-59） | `30` |
| `SS` | 秒（00-59） | `45` |
| `AM` / `PM` | 午前/午後 | `PM` |
| `Day` | 曜日名 | `Monday` |
| `Mon` | 月名（短縮） | `Jan` |
| `TZ` | タイムゾーン | `JST` |

---

## 集約関数

| 関数 | 説明 | 例 |
|------|------|-----|
| `count(*)` | 行数 | `SELECT count(*) FROM users` |
| `count(column)` | NULL以外の行数 | `SELECT count(email) FROM users` |
| `count(distinct column)` | ユニークな値の数 | `SELECT count(distinct status) FROM orders` |
| `sum(column)` | 合計 | `SELECT sum(amount) FROM orders` |
| `avg(column)` | 平均 | `SELECT avg(price) FROM products` |
| `max(column)` | 最大値 | `SELECT max(created_at) FROM users` |
| `min(column)` | 最小値 | `SELECT min(price) FROM products` |
| `array_agg(column)` | 配列に集約 | `SELECT array_agg(name) FROM users` |
| `string_agg(column, delim)` | 文字列に連結 | `SELECT string_agg(name, ', ') FROM users` |
| `bool_and(column)` | すべてtrueか | `SELECT bool_and(is_active) FROM users` |
| `bool_or(column)` | いずれかtrueか | `SELECT bool_or(is_admin) FROM users` |
| `json_agg(column)` | JSON配列に集約 | `SELECT json_agg(row_to_json(t)) FROM t` |
| `jsonb_agg(column)` | JSONB配列に集約 | `SELECT jsonb_agg(data) FROM items` |

---

## 条件式

| 関数・構文 | 説明 | 例 |
|-----------|------|-----|
| `CASE WHEN ... THEN ... ELSE ... END` | 条件分岐 | `CASE WHEN status = 1 THEN 'active' ELSE 'inactive' END` |
| `COALESCE(a, b, ...)` | NULLを別の値に置き換える。<br>引数を左から評価していき、最初のNULLではない値を返す。 | `COALESCE(nickname, name, 'anonymous')` |
| `NULLIF(a, b)` | 特定の値をNULLにする。a == b ならNULLを返す。 | `NULLIF(value, 0)` |

### CASE式の例

```sql
SELECT 
  name,
  CASE 
    WHEN age < 20 THEN '未成年'
    WHEN age < 65 THEN '成人'
    ELSE '高齢者'
  END AS age_group
FROM users;
--     name    | age_group 
-- ------------+-----------
--  山田太郎   | 成人
--  鈴木花子   | 成人
--  田中一郎   | 高齢者
--  佐藤雪     | 未成年
-- ...


-- 簡略形（値の比較）
SELECT 
  id,
  CASE status
    WHEN 'pending' THEN '保留中'
    WHEN 'paid' THEN '支払済'
    WHEN 'shipped' THEN '発送済み'
    WHEN 'delivered' THEN '配達済み'
    WHEN 'cancelled' THEN 'キャンセル済み'
    ELSE '不明'
  END AS status_label
FROM orders;
--                  id                  |  status_label  
-- --------------------------------------+----------------
--  49a93d17-2bd5-4ca6-85a9-35e161bea684 | 発送済み
--  247a16e5-f803-42c8-88af-c4d990f2bcc3 | 支払済
--  bdfc9139-e9fc-4880-942b-21f7243a242c | 保留中
-- ...
```


### COALESCE の例

`COALESCE(a, b, c, ...)` は引数を左から評価していき最初のNULLではない値を返します。

```sql
-- 表示名のフォールバック
-- ニックネームがあれば使う、なければ本名、それもなければ「匿名」
SELECT COALESCE(nickname, name, 'anonymous') AS display_name FROM users;
--  display_name 
-- --------------
--  たろさん
--  はなちゃん
--  田中一郎

-- NULLを0として扱う
-- discountがNULLの場合、0として扱う
SELECT
  name,
  discount,
  price,
  floor(price - price * COALESCE(discount, 0) / 100) AS final_price
FROM
  products;
--                     name                     | discount |   price   | final_price 
-- ---------------------------------------------+----------+-----------+-------------
--  iPhone 15 Pro 256GB                         |          | 179800.00 |      179800
--  Galaxy S24 Ultra                            |     5.00 | 189800.00 |      180310
--  Pixel 8 Pro                                 |    10.00 | 159900.00 |      143910


-- 外部結合でのNULLの処理
-- 注文がないユーザーはNULLではなく0と表示される
SELECT 
  u.name,
  COALESCE(SUM(o.total_amount), 0) AS total_orders
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
GROUP BY u.name;
--     name    | total_orders 
-- ------------+--------------
--  原駿       |    176800.00
--  山崎颯太   |     37980.00
--  池田海斗   |    179800.00
```

### NULLIFの例

`NULLIF(a, b)` は `a == b` ならNULLを返します。

```sql
-- 0除算の回避
SELECT 100 / NULLIF(divisor, 0) FROM data;  -- NULL

-- 空文字をNULLとして扱う
SELECT NULLIF(email, '') AS email FROM users;

-- COALESCEとの組み合わせ
SELECT COALESCE(NULLIF(email, ''), 'メール未設定') AS email FROM users;
```

---

## JSON関数

| 関数 | 説明 | 例 |
|------|------|-----|
| `->` | JSONオブジェクトからキーで取得（JSON型） | `data->'name'` |
| `->>` | JSONオブジェクトからキーで取得（テキスト型） | `data->>'name'` |
| `#>` | パスで取得（JSON型） | `data#>'{address,city}'` |
| `#>>` | パスで取得（テキスト型） | `data#>>'{address,city}'` |
| `jsonb_extract_path(json, ...)` | パスで値を取得 | `jsonb_extract_path(data, 'address', 'city')` |
| `jsonb_extract_path_text(...)` | パスでテキスト取得 | `jsonb_extract_path_text(data, 'name')` |
| `jsonb_set(json, path, value)` | 値を設定 | `jsonb_set(data, '{name}', '"new"')` |
| `jsonb_insert(json, path, value)` | 値を挿入 | `jsonb_insert(data, '{tags,0}', '"new"')` |
| `jsonb_array_elements(json)` | 配列を行に展開 | `jsonb_array_elements('[1,2,3]')` |
| `jsonb_object_keys(json)` | キー一覧を取得 | `jsonb_object_keys('{"a":1,"b":2}')` |
| `jsonb_each(json)` | キーと値のペアを行に展開 | `jsonb_each('{"a":1,"b":2}')` |
| `jsonb_typeof(json)` | JSON値の型 | `jsonb_typeof('"hello"')` → `string` |
| `to_jsonb(value)` | 値をJSONBに変換 | `to_jsonb(row)` |
| `row_to_json(record)` | レコードをJSONに | `row_to_json(users)` |
| `jsonb_build_object(k1, v1, ...)` | JSONBオブジェクトを作成 | `jsonb_build_object('name', 'taro', 'age', 20)` |
| `jsonb_build_array(...)` | JSONB配列を作成 | `jsonb_build_array(1, 2, 3)` |
| `jsonb_strip_nulls(json)` | NULL値を除去 | `jsonb_strip_nulls('{"a":1,"b":null}')` |

### JSON関数の使用例

```sql
-- テーブル
CREATE TABLE users (
    id serial PRIMARY KEY,
    data jsonb
);

INSERT INTO users (data) VALUES 
    ('{"name": "田中", "age": 30, "tags": ["admin", "developer"]}');

-- 値の取得
SELECT data->>'name' AS name FROM users;  -- 田中
SELECT data->'tags'->0 FROM users;        -- "admin"

-- 配列を行に展開
SELECT jsonb_array_elements_text(data->'tags') AS tag FROM users;
-- admin
-- developer

-- 値の更新
UPDATE users 
SET data = jsonb_set(data, '{age}', '31')
WHERE id = 1;
```

---

## 配列関数

| 関数 | 説明 | 例 | 結果 |
|------|------|-----|------|
| `array_length(arr, dim)` | 配列の長さ | `array_length('{1,2,3}'::int[], 1)` | `3` |
| `array_append(arr, elem)` | 要素を追加 | `array_append('{1,2}'::int[], 3)` | `{1,2,3}` |
| `array_prepend(elem, arr)` | 先頭に追加 | `array_prepend(0, '{1,2}'::int[])` | `{0,1,2}` |
| `array_cat(arr1, arr2)` | 配列を連結 | `array_cat('{1,2}'::int[], '{3,4}'::int[])` | `{1,2,3,4}` |
| `array_remove(arr, elem)` | 要素を削除 | `array_remove('{1,2,3}'::int[], 2)` | `{1,3}` |
| `array_position(arr, elem)` | 要素の位置 | `array_position('{a,b,c}'::text[], 'b')` | `2` |
| `unnest(arr)` | 配列を行に展開 | `unnest('{1,2,3}'::int[])` | 3行 |
| `array_agg(column)` | 行を配列に集約 | `SELECT array_agg(name) FROM users` | `{田中,鈴木}` |

---

## 型変換関数

| 関数 | 説明 | 例 |
|------|------|-----|
| `CAST(value AS type)` | 型変換（SQL標準） | `CAST('123' AS integer)` |
| `value::type` | 型変換（PostgreSQL形式） | `'123'::integer` |
| `to_char(n, format)` | 数値を文字列に | `to_char(12345.6, '999,999.99')` |
| `to_number(str, format)` | 文字列を数値に | `to_number('12,345.67', '99,999.99')` |

---

## システム情報関数

| 関数 | 説明 |
|------|------|
| `current_user` | 現在のユーザー名 |
| `current_database()` | 現在のデータベース名 |
| `current_schema()` | 現在のスキーマ名 |
| `version()` | PostgreSQLのバージョン |
| `pg_database_size(db)` | データベースのサイズ |
| `pg_table_size(table)` | テーブルのサイズ |
| `pg_total_relation_size(table)` | テーブル＋インデックスのサイズ |
| `pg_size_pretty(size)` | サイズを人間が読める形式に |

```sql
-- 例
SELECT current_user;                           -- postgres
SELECT current_database();                     -- mydb
SELECT pg_size_pretty(pg_database_size('mydb')); -- 8 MB
```

# 2.2 WHERE句・ORDER BY・GROUP Byの活用

# 2.3 集約関数とウィンドウ関数

# 2.4 サブクエリとCTE (WITH句)

# 2.5 INSERT / UPDATE / DELETE の基本操作

# 2.6 トランザクションとACID特性